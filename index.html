<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>LINE LIFF Coupon Manager</title>
</head>
<body onload="initLiff()">
<h1>สร้างคูปอง</h1>
<form onsubmit="createCoupon(); return false;">
  <label>ประเภทคูปอง:
    <select id="couponType">
      <option value="discount_fixed">ส่วนลดคงที่</option>
      <option value="discount_percent">ส่วนลดเปอร์เซ็นต์</option>
      <option value="free_item">แลกของฟรี</option>
    </select>
  </label><br><br>

  <label>ชื่อคูปอง: <input id="title" value="Friends-only coupon"></label><br><br>
  <label>คำอธิบาย: <textarea id="description">- แสดงคูปองนี้กับพนักงาน\n- ใช้ได้ครั้งเดียว</textarea></label><br><br>
  <label>ลิงก์รูปภาพ: <input id="imageUrl" value="https://developers.line.biz/media/messaging-api/coupon/sample-coupon-image-100-yen-off.jpg"></label><br><br>
  <label>วันหมดอายุ: <input type="date" id="expiryDate"></label><br><br>
  <button type="submit">สร้างคูปอง</button>
</form>

<h2>รายการคูปอง</h2>
<table border="1">
  <thead>
    <tr>
      <th>User ID</th>
      <th>Coupon ID</th>
      <th>ประเภท</th>
      <th>วันหมดอายุ</th>
      <th>สถานะ</th>
      <th>การจัดการ</th>
    </tr>
  </thead>
  <tbody id="couponTableBody"></tbody>
</table>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
const EDGE_URL = "https://mihtvcbzguzkvfwnlnem.supabase.co/functions/v1/coupon-service";
const LIFF_ID = "2005780370-Ybr8MVR2";

async function callEdge(action, payload = {}) {
  const res = await fetch(EDGE_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action, payload })
  });
  return await res.json();
}

async function createCoupon() {
  const couponType = document.getElementById('couponType').value;
  const expiryDate = document.getElementById('expiryDate').value;
  const title = document.getElementById('title').value;
  const description = document.getElementById('description').value;
  const imageUrl = document.getElementById('imageUrl').value;

  const profile = await liff.getProfile();

  const result = await callEdge("create", {
    user_id: profile.userId,
    coupon_type: couponType,
    expiry_date: expiryDate,
    title,
    description,
    imageUrl
  });

  if (result.success) {
    await shareCoupon(couponType, expiryDate);
    loadCoupons();
  } else {
    alert("สร้างคูปองไม่สำเร็จ: " + result.error);
  }
}

async function loadCoupons() {
  const result = await callEdge("list");
  const tbody = document.getElementById('couponTableBody');
  tbody.innerHTML = result.data.map(c => `
    <tr>
      <td>${c.user_id}</td>
      <td>${c.coupon_id}</td>
      <td>${c.coupon_type}</td>
      <td>${c.expiry_date}</td>
      <td>${c.status}</td>
      <td>
        <button onclick="closeCoupon('${c.coupon_id}')">ปิด</button>
        <button onclick="shareCoupon('${c.coupon_type}','${c.expiry_date}')">แชร์</button>
      </td>
    </tr>
  `).join("");
}

async function closeCoupon(id) {
  await callEdge("close", { coupon_id: id });
  loadCoupons();
}

async function shareCoupon(type, expiry) {
  const flexMsg = {
    type: "flex",
    altText: "คูปอง",
    contents: {
      type: "bubble",
      body: {
        type: "box",
        layout: "vertical",
        contents: [
          { type: "text", text: type, weight: "bold", size: "xl" },
          { type: "text", text: `หมดอายุ: ${expiry}`, size: "sm", color: "#999999" }
        ]
      }
    }
  };
  await liff.shareTargetPicker([flexMsg]);
}

async function initLiff() {
  await liff.init({ liffId: LIFF_ID });
  if (!liff.isLoggedIn()) liff.login();
  loadCoupons();
}
</script>
</body>
</html>
