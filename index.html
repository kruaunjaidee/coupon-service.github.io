<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LIFF Coupon Service</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    button { margin: 2px; }
  </style>
</head>
<body>
  <h1>สร้างคูปอง</h1>
  <label>ประเภทคูปอง:
    <select id="type">
      <option value="discount">ส่วนลด</option>
      <option value="free_item">ของฟรี</option>
      <option value="special_access">สิทธิพิเศษ</option>
    </select>
  </label><br><br>
  <label>วันหมดอายุ: <input type="date" id="expire" /></label><br><br>
  <button onclick="createCoupon()">สร้างคูปอง</button>

  <h2>ตารางคูปอง</h2>
  <table>
    <thead>
      <tr>
        <th>User ID</th>
        <th>Coupon ID</th>
        <th>ประเภท</th>
        <th>วันหมดอายุ</th>
        <th>จัดการ</th>
      </tr>
    </thead>
    <tbody id="couponTable"></tbody>
  </table>

<script>
const EDGE_URL = "https://mihtvcbzguzkvfwnlnem.supabase.co/functions/v1/coupon-service";
let userId = "";

// ฟังก์ชันเรียก Edge Function
async function callEdge(path, method = "GET", body) {
  const res = await fetch(`${EDGE_URL}${path}`, {
    method,
    headers: { "Content-Type": "application/json" },
    body: body ? JSON.stringify(body) : undefined,
  });
  if (!res.ok) throw new Error(await res.text());
  return await res.json();
}

// สร้างคูปองใหม่
async function createCoupon() {
  const type = document.getElementById("type").value;
  const expire = document.getElementById("expire").value;
  const couponId = "CPN" + Date.now();
  await callEdge("/create", "POST", { userId, couponId, type, expireDate: expire });
  await loadCoupons();
}

// โหลดคูปองจาก Supabase
async function loadCoupons() {
  const coupons = await callEdge("/list");
  const tbody = document.getElementById("couponTable");
  tbody.innerHTML = "";
  coupons.forEach(c => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${c.user_id}</td>
      <td>${c.coupon_id}</td>
      <td>${c.type}</td>
      <td>${c.expire_date}</td>
      <td>
        <button onclick="shareCoupon('${c.coupon_id}', '${c.type}', '${c.expire_date}')">แชร์</button>
        <button onclick="closeCoupon('${c.coupon_id}')">ปิด</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// ปิดคูปอง
async function closeCoupon(couponId) {
  await callEdge(`/close/${couponId}`, "PUT");
  await loadCoupons();
}

// แชร์คูปองผ่าน LIFF
function shareCoupon(couponId, type, expireDate) {
  const message = {
    type: "flex",
    altText: "คุณได้รับคูปอง",
    contents: {
      type: "bubble",
      body: {
        type: "box",
        layout: "vertical",
        contents: [
          { type: "text", text: "คูปองพิเศษ", weight: "bold", size: "xl" },
          { type: "text", text: `ประเภท: ${type}` },
          { type: "text", text: `รหัส: ${couponId}` },
          { type: "text", text: `หมดอายุ: ${expireDate}` }
        ]
      }
    }
  };
  liff.shareTargetPicker([message]);
}

// เริ่ม LIFF
async function initLiff() {
  await liff.init({ liffId: "2005780370-Ybr8MVR2" });
  if (!liff.isLoggedIn()) { liff.login(); return; }
  const profile = await liff.getProfile();
  userId = profile.userId;
  await loadCoupons();
}

initLiff();
</script>
</body>
</html>
