<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Flex Coupon Generator + Supabase</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>
</head>
<body class="bg-gray-50 p-6 font-sans antialiased">

<h1 class="text-3xl font-bold text-green-600 mb-6">Flex Coupon Generator + Supabase</h1>

<h2 class="text-xl font-semibold text-gray-800 mb-4">Channel Access Tokens</h2>
<div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-6">
  <select id="tokenSelect" class="border border-gray-300 rounded-lg px-4 py-2 bg-white text-gray-800 focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:outline-none w-full sm:w-1/3"></select>
  <input type="text" id="tokenName" placeholder="ชื่อ Bot" class="border border-gray-300 rounded-lg px-4 py-2 bg-white text-gray-800 focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:outline-none w-full sm:w-1/3"/>
  <input type="text" id="tokenValue" placeholder="Channel Access Token" class="border border-gray-300 rounded-lg px-4 py-2 bg-white text-gray-800 focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:outline-none w-full sm:w-1/3"/>
  <button onclick="addToken()" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors w-full sm:w-auto">เพิ่ม Token</button>
</div>

<h2 class="text-xl font-semibold text-gray-800 mb-4">สร้างคูปอง</h2>
<div class="space-y-6 mb-6">
  <label class="block">
    <span class="text-gray-700 font-medium text-lg">Coupon Name:</span>
    <input type="text" id="userId" class="mt-2 block w-full border-gray-300 rounded-lg shadow-sm px-4 py-3 bg-white text-gray-800 text-base focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:outline-none"/>
  </label>
  <label class="block">
    <span class="text-gray-700 font-medium text-lg">ประเภทคูปอง:</span>
    <select id="type" class="mt-2 block w-full border-gray-300 rounded-lg shadow-sm px-4 py-3 bg-white text-gray-800 text-base focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:outline-none">
      <option value="discount">ส่วนลด</option>
      <option value="free_item">ของฟรี</option>
      <option value="special_access">สิทธิพิเศษ</option>
    </select>
  </label>
  <label class="block">
    <span class="text-gray-700 font-medium text-lg">วันหมดอายุ:</span>
    <input type="date" id="expire" class="mt-2 block w-full border-gray-300 rounded-lg shadow-sm px-4 py-3 bg-white text-gray-800 text-base focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:outline-none"/>
  </label>
  <label class="block">
    <span class="text-gray-700 font-medium text-lg">Image URL (optional):</span>
    <input type="text" id="imageUrl" placeholder="https://example.com/image.jpg" class="mt-2 block w-full border-gray-300 rounded-lg shadow-sm px-4 py-3 bg-white text-gray-800 text-base focus:border-green-500 focus:ring-2 focus:ring-green-500 focus:outline-none"/>
  </label>
  <button onclick="createCoupon()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors w-full sm:w-auto">สร้างคูปอง</button>
</div>

<h2 class="text-xl font-semibold text-gray-800 mb-4">Sync คูปองจาก LINE</h2>
<button onclick="syncCoupons()" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600 transition-colors w-full sm:w-auto">Sync</button>

<h2 class="text-xl font-semibold text-gray-800 mb-4 mt-6">ตารางคูปอง</h2>
<table class="min-w-full divide-y divide-gray-200 bg-white shadow-md rounded-lg overflow-hidden">
<thead class="bg-gray-50">
<tr>
<th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Coupon Name</th>
<th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ประเภท</th>
<th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">วันหมดอายุ</th>
<th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">จัดการ</th>
</tr>
</thead>
<tbody id="couponTable" class="divide-y divide-gray-200"></tbody>
</table>

<!-- <h2 class="text-xl font-semibold text-gray-800 mb-4 mt-6">Coupon Message Preview</h2>
<textarea id="couponPreview" readonly class="w-full h-48 font-mono text-sm border border-gray-300 rounded-lg shadow-sm p-3 bg-gray-100 text-gray-800"></textarea> -->

<script>
const EDGE_URL = "https://mihtvcbzguzkvfwnlnem.supabase.co/functions/v1/coupon-service";
const DEFAULT_IMAGE = "https://developers.line.biz/media/messaging-api/coupon/sample-coupon-image-100-yen-off.jpg";

async function callEdge(path, method="GET", body=null){
  const res = await fetch(`${EDGE_URL}${path}`,{
    method,
    headers:{ "Content-Type":"application/json" },
    body: body ? JSON.stringify(body):undefined
  });
  if(!res.ok) throw new Error(await res.text());
  return await res.json();
}

async function loadTokens(){
  try {
    const tokens = await callEdge("/tokens");
    const select = document.getElementById("tokenSelect");
    select.innerHTML="";
    tokens.forEach(t=>{
      const opt = document.createElement("option");
      opt.value = t.token;
      opt.textContent = t.name;
      select.appendChild(opt);
    });
  } catch(err) {
    Swal.fire('โหลด Token ไม่สำเร็จ', err.message, 'error');
  }
}

async function addToken(){
  const name = document.getElementById("tokenName").value.trim();
  const token = document.getElementById("tokenValue").value.trim();
  if(!name||!token){ Swal.fire('กรอกข้อมูลให้ครบ', '', 'warning'); return; }
  try {
    await callEdge("/tokens","POST",{name,token});
    document.getElementById("tokenName").value="";
    document.getElementById("tokenValue").value="";
    await loadTokens();
    Swal.fire('เพิ่ม Token สำเร็จ', '', 'success');
  } catch(err) {
    Swal.fire('เพิ่ม Token ไม่สำเร็จ', err.message, 'error');
  }
}

async function createCoupon(){
  const userId = document.getElementById("userId").value.trim();
  const type = document.getElementById("type").value;
  const expire = document.getElementById("expire").value;
  const imageUrl = document.getElementById("imageUrl").value.trim() || DEFAULT_IMAGE;
  const token = document.getElementById("tokenSelect").value;
  if(!userId||!expire||!token){ Swal.fire('กรอกให้ครบทุกช่อง', '', 'warning'); return; }

  if (!imageUrl.startsWith('https://')) {
    Swal.fire('Image URL ต้องเป็น HTTPS', 'กรุณาใส่ URL ที่ถูกต้องหรือปล่อยว่างเพื่อใช้ค่าเริ่มต้น', 'warning');
    return;
  }

  const endDate = new Date(`${expire}T23:59:59+07:00`);
  const endTimestamp = Math.floor(endDate.getTime() / 1000);

  const bodyLINE = {
    title:"Friends-only coupon",
    description:"- แสดงหน้าจอนี้ให้พนักงานดู\n- ใช้แล้วไม่สามารถใช้ซ้ำ\n- คูปองอาจเปลี่ยนแปลง/ยกเลิกได้โดยไม่แจ้งล่วงหน้า",
    reward:{ type:"discount", priceInfo:{ type:"fixed", fixedAmount:100 } },
    acquisitionCondition:{ type:"normal" },
    startTimestamp:0,
    endTimestamp: endTimestamp,
    imageUrl: imageUrl,
    timezone:"ASIA_BANGKOK",
    visibility:"UNLISTED",
    maxUseCountPerTicket:1
  };

  try{
    Swal.fire({
      title: 'กำลังสร้างคูปอง...',
      text: 'กรุณารอสักครู่',
      icon: 'info',
      allowOutsideClick: false,
      showConfirmButton: false,
      willOpen: () => Swal.showLoading()
    });
    const lineRes = await callEdge("/line-create","POST",{token,bodyLINE});
    const couponId = lineRes.data.couponId;
    await callEdge("/create","POST",{userId,couponId,type,expireDate:expire,imageUrl});
    await loadCoupons();
    generateCouponMessage(couponId);
    Swal.fire('สร้างคูปองสำเร็จ', '', 'success');
  }catch(err){ Swal.fire('สร้างคูปองไม่สำเร็จ', err.message, 'error'); }
}

async function syncCoupons(){
  const token = document.getElementById("tokenSelect").value;
  if(!token){ Swal.fire('เลือก Token ก่อน', '', 'warning'); return; }
  try{
    Swal.fire({
      title: 'กำลัง Sync คูปอง...',
      text: 'กรุณารอสักครู่',
      icon: 'info',
      allowOutsideClick: false,
      showConfirmButton: false,
      willOpen: () => Swal.showLoading()
    });
    await callEdge("/sync","POST",{token});
    await loadCoupons();
    Swal.fire('Sync สำเร็จ', '', 'success');
  }catch(err){ Swal.fire('Sync ไม่สำเร็จ', err.message, 'error'); }
}

async function loadCoupons(){
  try {
    const coupons = await callEdge("/list");
    const tbody = document.getElementById("couponTable");
    tbody.innerHTML = "";
    coupons.forEach(c=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-center text-gray-800">${c.user_id}</td>
        <td class="px-6 py-4 whitespace-nowrap text-center text-gray-800">${c.type}</td>
        <td class="px-6 py-4 whitespace-nowrap text-center text-gray-800">${c.expire_date}</td>
        <td class="px-6 py-4 whitespace-nowrap text-center">
          <button onclick="showCouponModal('${c.coupon_id}', '${c.user_id}', '${c.type}', '${c.expire_date}')" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">Preview</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  } catch(err) {
    Swal.fire('โหลดคูปองไม่สำเร็จ', err.message, 'error');
  }
}

async function closeCoupon(couponId){
  const token = document.getElementById("tokenSelect").value;
  if(!token){ Swal.fire('เลือก Token ก่อน', '', 'warning'); return; }
  try {
    Swal.fire({
      title: 'กำลังปิดคูปอง...',
      text: 'กรุณารอสักครู่',
      icon: 'info',
      allowOutsideClick: false,
      showConfirmButton: false,
      willOpen: () => Swal.showLoading()
    });
    await callEdge(`/close/${couponId}`,"PUT",{token});
    await loadCoupons();
    Swal.fire('ปิดและลบคูปองสำเร็จ', '', 'success');
  } catch(err) {
    Swal.fire('ปิดคูปองไม่สำเร็จ', err.message, 'error');
  }
}

function showCouponModal(couponId, couponName, type, expireDate) {
  const couponMessage = generateCouponMessageObject(couponId);
  const jsonString = JSON.stringify(couponMessage, null, 2);
  
  Swal.fire({
    title: 'รายละเอียดคูปอง',
    html: `
      <div class="text-left space-y-4">
        <div>
          <p class="font-medium text-gray-700">Coupon Name:</p>
          <p class="text-gray-800">${couponName}</p>
        </div>
        <div>
          <p class="font-medium text-gray-700">Coupon ID:</p>
          <p class="text-gray-800">${couponId}</p>
        </div>
        <div>
          <p class="font-medium text-gray-700">ประเภท:</p>
          <p class="text-gray-800">${type}</p>
        </div>
        <div>
          <p class="font-medium text-gray-700">วันหมดอายุ:</p>
          <p class="text-gray-800">${expireDate}</p>
        </div>
        <div>
          <p class="font-medium text-gray-700">Coupon Message Preview:</p>
          <textarea readonly class="w-full h-32 font-mono text-sm border border-gray-300 rounded-lg p-3 bg-gray-100 text-gray-800">${jsonString}</textarea>
        </div>
        <div class="flex flex-col space-y-4">
          <button id="closeCouponBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">ปิดคูปอง</button>
          <button id="copyJsonBtn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors">คัดลอก JSON</button>
        </div>
      </div>
    `,
    showConfirmButton: false,
    showCloseButton: true,
    customClass: {
      popup: 'w-full max-w-lg p-6',
    },
    didOpen: () => {
      document.getElementById('closeCouponBtn').addEventListener('click', () => {
        Swal.close();
        closeCoupon(couponId);
      });
      document.getElementById('copyJsonBtn').addEventListener('click', () => {
        copyCouponMessage(couponId);
      });
    }
  });
}

function copyCouponMessage(couponId) {
  const couponMessage = generateCouponMessageObject(couponId);
  const jsonString = JSON.stringify(couponMessage, null, 2);
  
  try {
    navigator.clipboard.writeText(jsonString).then(() => {
      Swal.fire('คัดลอก JSON สำเร็จ', 'JSON ของคูปองถูกคัดลอกไปยังคลิปบอร์ดแล้ว', 'success');
    }).catch(err => {
      const textarea = document.createElement('textarea');
      textarea.value = jsonString;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.focus();
      textarea.select();
      try {
        document.execCommand('copy');
        Swal.fire('คัดลอก JSON สำเร็จ', 'JSON ของคูปองถูกคัดลอกไปยังคลิปบอร์ดแล้ว', 'success');
      } catch (fallbackErr) {
        Swal.fire('คัดลอก JSON ไม่สำเร็จ', 'ไม่สามารถคัดลอก JSON ได้ กรุณาคัดลอกจากช่อง Preview', 'error');
      }
      document.body.removeChild(textarea);
    });
  } catch (err) {
    const textarea = document.createElement('textarea');
    textarea.value = jsonString;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();
    try {
      document.execCommand('copy');
      Swal.fire('คัดลอก JSON สำเร็จ', 'JSON ของคูปองถูกคัดลอกไปยังคลิปบอร์ดแล้ว', 'success');
    } catch (fallbackErr) {
      Swal.fire('คัดลอก JSON ไม่สำเร็จ', 'ไม่สามารถคัดลอก JSON ได้ กรุณาคัดลอกจากช่อง Preview', 'error');
    }
    document.body.removeChild(textarea);
  }
}

function generateCouponMessageObject(couponId) {
  return {
    type: "coupon",
    couponId: couponId
  };
}

function generateCouponMessage(couponId) {
  const couponMessage = generateCouponMessageObject(couponId);
  document.getElementById("couponPreview").value = JSON.stringify(couponMessage, null, 2);
}

// initial load
loadTokens();
loadCoupons();
</script>

</body>
</html>
